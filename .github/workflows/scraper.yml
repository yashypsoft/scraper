name: Parallel Scraper

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:
  run:
    runs-on: ubuntu-latest-16-cores  # Or ubuntu-22.04-large
    timeout-minutes: 240
    
    strategy:
      matrix:
        php-version: ["8.2"]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup PHP with parallel extensions
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: ftp, simplexml, pcntl, posix, curl, sockets
          ini-values: |
            memory_limit=4096M
            max_execution_time=0
            max_input_time=-1
            default_socket_timeout=600
            curl.cainfo=/etc/ssl/certs/ca-certificates.crt
          tools: composer
            
      - name: Install dependencies
        run: |
          composer require amphp/amp
          composer require amphp/parallel
          composer require amphp/process
          composer require league/csv
          
      - name: Run parallel scraper
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
          FTP_BASE_DIR: ${{ secrets.FTP_OUTPUT_PATH }}
          CURR_URL: ${{ secrets.CURR_URL }}
          MAX_WORKERS: 16
          BATCH_SIZE: 1000
        run: php parallel_scraper.php
        
      - name: Upload CSV artifact
        uses: actions/upload-artifact@v4
        with:
          name: products_full
          path: products_full.csv
          if-no-files-found: error
          
      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scraper-logs
          path: scraper_*.log