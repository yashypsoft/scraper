name: Emma Mason Algolia Scraper

on:
  workflow_dispatch:
    inputs:
      page:
        description: "Page number (0 = all pages)"
        default: "0"
      hits_per_page:
        description: "Algolia hits per page"
        default: "24"
      max_workers:
        description: "Parallel worker threads"
        default: "8"
      request_delay:
        description: "Delay per request in seconds"
        default: "0.1"
      timeout:
        description: "Request timeout in seconds"
        default: "30"
      retries:
        description: "Retry attempts per page"
        default: "3"

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run Emma Mason Algolia scraper
        env:
          PAGE: ${{ github.event.inputs.page }}
          HITS_PER_PAGE: ${{ github.event.inputs.hits_per_page }}
          MAX_WORKERS: ${{ github.event.inputs.max_workers }}
          REQUEST_DELAY: ${{ github.event.inputs.request_delay }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
          RETRIES: ${{ github.event.inputs.retries }}
        run: |
          echo "Starting Emma Mason Algolia scraper:"
          echo "PAGE: $PAGE (0 means all pages)"
          echo "HITS_PER_PAGE: $HITS_PER_PAGE"
          echo "MAX_WORKERS: $MAX_WORKERS"
          echo "REQUEST_DELAY: $REQUEST_DELAY"
          echo "TIMEOUT: $TIMEOUT"
          echo "RETRIES: $RETRIES"
          echo ""

          python drl/em_algolia_fetch.py \
            --page "$PAGE" \
            --hits-per-page "$HITS_PER_PAGE" \
            --max-workers "$MAX_WORKERS" \
            --delay "$REQUEST_DELAY" \
            --timeout "$TIMEOUT" \
            --retries "$RETRIES" \
            --output-csv "products_chunk_${PAGE}.csv" \
            --output-json "drl/em_algolia_records.json"

          echo ""
          echo "Generated files:"
          ls -la products_chunk_*.csv drl/em_algolia_records.json 2>/dev/null || true

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: em_algolia_results_${{ github.event.inputs.page }}
          path: |
            products_chunk_*.csv
            drl/em_algolia_records.json
          if-no-files-found: error
