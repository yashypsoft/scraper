name: Solve CAPTCHA with Audio

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL containing CAPTCHA to solve'
        required: true
        default: 'https://www.google.com/recaptcha/api2/demo'
      solving_method:
        description: 'CAPTCHA solving method'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - audio
          - checkbox
      headless_mode:
        description: 'Run browser in headless mode'
        required: false
        default: true
        type: boolean
      timeout_seconds:
        description: 'Timeout in seconds'
        required: false
        default: '120'
        type: string

env:
  PYTHON_VERSION: '3.10'
  LOG_DIR: 'captcha_logs'

jobs:
  setup-dependencies:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Chrome and ChromeDriver
      run: |
        echo "Installing Chrome and ChromeDriver..."
        
        # Install Chrome from Google's official repository
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # Get Chrome version
        CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d'.' -f1)
        echo "Chrome version: $CHROME_VERSION"
        
        # Download matching ChromeDriver
        wget -q "https://storage.googleapis.com/chrome-for-testing-public/$CHROME_VERSION.0.0/linux64/chromedriver-linux64.zip"
        unzip -q chromedriver-linux64.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        
        # Verify installations
        google-chrome --version
        chromedriver --version
        
        echo "âœ… Chrome and ChromeDriver installed successfully"
    
    - name: Install audio dependencies
      run: |
        echo "Installing audio dependencies..."
        sudo apt-get update
        
        # Install audio libraries
        sudo apt-get install -y \
          python3-pyaudio \
          portaudio19-dev \
          libasound2-dev \
          ffmpeg \
          flac \
          sox
        
        echo "âœ… Audio dependencies installed"

  install-python-packages:
    runs-on: ubuntu-latest
    needs: setup-dependencies
    timeout-minutes: 5
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install core Python packages
      run: |
        echo "Installing Python packages..."
        python -m pip install --upgrade pip
        
        # Install core dependencies
        pip install \
          selenium==4.15.0 \
          requests==2.31.0 \
          pillow==10.1.0
        
        echo "âœ… Core Python packages installed"
    
    - name: Install audio Python packages
      run: |
        echo "Installing audio processing packages..."
        pip install \
          SpeechRecognition==3.10.0 \
          pydub==0.25.1
        
        echo "âœ… Audio packages installed"

  solve-captcha:
    runs-on: ubuntu-latest
    needs: install-python-packages
    timeout-minutes: 15
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Create log directory
      run: |
        mkdir -p ${{ env.LOG_DIR }}
        echo "Log directory created: ${{ env.LOG_DIR }}"
    
    - name: Run CAPTCHA solver
      env:
        TARGET_URL: ${{ github.event.inputs.target_url }}
        SOLVING_METHOD: ${{ github.event.inputs.solving_method }}
        HEADLESS_MODE: ${{ github.event.inputs.headless_mode }}
        TIMEOUT_SECONDS: ${{ github.event.inputs.timeout_seconds }}
        LOG_DIR: ${{ env.LOG_DIR }}
        PYTHON_VERSION: ${{ env.PYTHON_VERSION }}
      run: |
        echo "========================================="
        echo "ðŸš€ CAPTCHA Solver with Audio Support"
        echo "========================================="
        echo ""
        echo "ðŸ“‹ Configuration:"
        echo "  URL: $TARGET_URL"
        echo "  Method: $SOLVING_METHOD"
        echo "  Headless: $HEADLESS_MODE"
        echo "  Timeout: $TIMEOUT_SECONDS seconds"
        echo "  Logs: $LOG_DIR"
        echo ""
        echo "ðŸ› ï¸ Environment:"
        echo "  Python: $PYTHON_VERSION"
        echo "  Chrome: $(google-chrome --version | head -n1)"
        echo "  ChromeDriver: $(chromedriver --version | head -n1)"
        echo ""
        echo "========================================="
        
        # Make script executable if needed
        chmod +x test.py 2>/dev/null || true
        
        # Run the CAPTCHA solver
        echo "Starting CAPTCHA solver..."
        
        python test.py \
          --url "$TARGET_URL" \
          --method "$SOLVING_METHOD" \
          --headless "$HEADLESS_MODE" \
          --log-dir "$LOG_DIR"
        
        echo "CAPTCHA solver execution completed"
    
    - name: Save debug artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: captcha-debug-artifacts
        path: |
          ${{ env.LOG_DIR }}/
          captcha_solver.log
          *.png
          *.mp3
          *.wav
        retention-days: 7
    
    - name: Generate summary report
      if: always()
      run: |
        echo "## CAPTCHA Solver Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- **Target URL:** ${{ github.event.inputs.target_url }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Solving Method:** ${{ github.event.inputs.solving_method }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Headless Mode:** ${{ github.event.inputs.headless_mode }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timeout:** ${{ github.event.inputs.timeout_seconds }} seconds" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### Dependencies Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Chrome: Installed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… ChromeDriver: Installed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Selenium: Installed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Audio Libraries: Installed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "${{ env.LOG_DIR }}" ]; then
          echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count files by type
          PNG_COUNT=$(find "${{ env.LOG_DIR }}" -name "*.png" -type f 2>/dev/null | wc -l || echo "0")
          LOG_COUNT=$(find "${{ env.LOG_DIR }}" -name "*.log" -type f 2>/dev/null | wc -l || echo "0")
          AUDIO_COUNT=$(find "${{ env.LOG_DIR }}" -name "*.mp3" -o -name "*.wav" -type f 2>/dev/null | wc -l || echo "0")
          
          echo "- Screenshots: $PNG_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- Log files: $LOG_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- Audio files: $AUDIO_COUNT" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. Download artifacts to view logs and screenshots" >> $GITHUB_STEP_SUMMARY
        echo "2. Check workflow logs for detailed execution output" >> $GITHUB_STEP_SUMMARY
        echo "3. For audio CAPTCHAs, verify Google Speech Recognition worked" >> $GITHUB_STEP_SUMMARY
        echo "4. Adjust timeout if CAPTCHA solving takes longer" >> $GITHUB_STEP_SUMMARY

  cleanup:
    runs-on: ubuntu-latest
    if: always()
    needs: solve-captcha
    
    steps:
    - name: Clean temporary files
      run: |
        echo "Cleaning up temporary files..."
        
        # Remove Chrome download files
        rm -f google-chrome-stable_current_amd64.deb 2>/dev/null || true
        rm -f chromedriver-linux64.zip 2>/dev/null || true
        rm -rf chromedriver-linux64 2>/dev/null || true
        
        # Clean Python cache
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        find . -name "*.pyc" -delete 2>/dev/null || true
        
        echo "âœ… Cleanup completed"