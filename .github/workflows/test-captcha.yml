name: Solve CAPTCHA with Audio

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: "URL containing CAPTCHA to solve"
        required: true
        default: "https://www.google.com/recaptcha/api2/demo"
      solving_method:
        description: "CAPTCHA solving method"
        required: false
        default: "auto"
        type: choice
        options: [auto, audio, checkbox]
      headless_mode:
        description: "Run browser in headless mode"
        required: false
        default: true
        type: boolean

env:
  PYTHON_VERSION: "3.10"
  LOG_DIR: "captcha_logs"

jobs:
  solve-captcha:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      # -----------------------------
      # System deps
      # -----------------------------
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            google-chrome-stable \
            ffmpeg \
            portaudio19-dev \
            libasound2-dev

          google-chrome --version

      # -----------------------------
      # Python deps
      # -----------------------------
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip

          pip install \
            selenium \
            requests \
            pillow \
            SpeechRecognition \
            pydub

      - name: Create log directory
        run: mkdir -p ${{ env.LOG_DIR }}

      # -----------------------------
      # Run solver
      # -----------------------------
      - name: Run CAPTCHA solver
        env:
          TARGET_URL: ${{ github.event.inputs.target_url }}
          SOLVING_METHOD: ${{ github.event.inputs.solving_method }}
          HEADLESS_MODE: ${{ github.event.inputs.headless_mode }}
        run: |
          echo "Starting CAPTCHA solver..."

          python test.py \
            --url "$TARGET_URL" \
            --method "$SOLVING_METHOD" \
            --log-dir "$LOG_DIR" \
            $([ "$HEADLESS_MODE" = "true" ] && echo "--headless")

      # -----------------------------
      # Artifacts
      # -----------------------------
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: captcha-debug
          path: |
            ${{ env.LOG_DIR }}/
            *.png
            *.mp3
            *.wav
          retention-days: 7